/**
 * @fileoverview added by tsickle
 * Generated from: lib/ng-terminal.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ViewChild, ElementRef, Input, Output, EventEmitter } from '@angular/core';
import { Terminal } from 'xterm';
import { FitAddon } from 'xterm-addon-fit';
import { Subject, combineLatest } from 'rxjs';
export class NgTerminalComponent {
    constructor() {
        this.keyInputSubject = new Subject();
        this.keyEventSubject = new Subject();
        this.termSnippetSubject = new Subject();
        this.afterViewInitSubject = new Subject();
        this.h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        this.displayOption = {};
        this.terminalStyle = {};
        this.keyInputEmitter = new EventEmitter();
        this.keyEventEmitter = new EventEmitter();
        this.termSnippetSubscription = combineLatest(this.termSnippetSubject, this.afterViewInitSubject).subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ([snippet]) => {
            snippet();
        }));
    }
    /**
     * @param {?} ds
     * @return {?}
     */
    set _dataSource(ds) {
        if (this.dataSourceSubscription != null) {
            this.dataSourceSubscription.unsubscribe();
        }
        this.dataSource = ds;
        this.dataSourceSubscription = this.dataSource.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.write(data);
        }));
    }
    /**
     * @return {?}
     */
    get _dataSource() {
        return this.dataSource;
    }
    /**
     * @param {?} opt
     * @return {?}
     */
    set _displayOption(opt) {
        this.setDisplayOption(opt);
    }
    /**
     * @param {?} opt
     * @return {?}
     */
    set _style(opt) {
        this.setStyle(opt);
    }
    /**
     * @private
     * @return {?}
     */
    observableSetup() {
        this.term.onData((/**
         * @param {?} input
         * @return {?}
         */
        (input) => {
            this.keyInputSubject.next(input);
        }));
        this.term.onKey((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.keyEventSubject.next(e);
        }));
        this.keyInputSubjectSubscription = this.keyInputSubject.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.keyInputEmitter.emit(data);
        }));
        this.keyEventSubjectSubscription = this.keyEventSubject.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.keyEventEmitter.emit(e);
        }));
        this.afterViewInitSubject.next();
    }
    /**
     * set block or inline-block to #terminal for fitting client or outer element
     * @private
     * @param {?} isBlock
     * @return {?}
     */
    setTerminalBlock(isBlock) {
        if (isBlock)
            this.terminalStyle['display'] = 'block';
        else
            this.terminalStyle['display'] = 'inline-block';
    }
    /**
     * set dimensions
     * @private
     * @param {?} left
     * @param {?} top
     * @param {?} width
     * @param {?} height
     * @return {?}
     */
    setTerminalDimensions(left, top, width, height) {
        this.terminalStyle['left'] = left ? `${left}px` : undefined;
        this.terminalStyle['top'] = top ? `${top}px` : undefined;
        this.terminalStyle['width'] = width ? `${width}px` : undefined;
        this.terminalStyle['height'] = height ? `${height}px` : undefined;
    }
    /**
     * remove dimensions
     * @private
     * @return {?}
     */
    removeTerminalDimensions() {
        this.terminalStyle['left'] = undefined;
        this.terminalStyle['top'] = undefined;
        this.terminalStyle['width'] = undefined;
        this.terminalStyle['height'] = undefined;
    }
    /**
     * @param {?} styleObject
     * @return {?}
     */
    setStyle(styleObject) {
        Object.assign(this.terminalStyle, styleObject);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * When a dimension of div changes, fit a terminal in div.
     * @return {?}
     */
    ngAfterViewChecked() {
        /** @type {?} */
        let dims = this.fitAddon.proposeDimensions();
        if (dims === undefined || isNaN(dims.rows) || dims.rows == Infinity || isNaN(dims.cols) || dims.cols == Infinity) {
            this.term.resize(10, 10);
        }
        else if (!this.displayOption.fixedGrid) {
            this.fitAddon.fit();
        }
        else {
            this.term.resize(this.displayOption.fixedGrid.cols, this.displayOption.fixedGrid.rows);
            /** @type {?} */
            let xtermScreen = this.term.element.getElementsByClassName('xterm-screen')[0];
            /** @type {?} */
            let scrollArea = this.term.element.getElementsByClassName('xterm-scroll-area')[0];
            /** @type {?} */
            let terminal = this.term.element;
            /** @type {?} */
            const contentWidth = xtermScreen.clientWidth;
            /** @type {?} */
            const scrollWidth = terminal.clientWidth - scrollArea.clientWidth;
            this.setTerminalDimensions(undefined, undefined, contentWidth + scrollWidth, undefined);
        }
    }
    /**
     * It creates new terminal in #terminal.
     * @return {?}
     */
    ngAfterViewInit() {
        this.fitAddon = new FitAddon();
        this.term = new Terminal();
        this.term.open(this.terminalDiv.nativeElement);
        this.term.loadAddon(this.fitAddon);
        this.observableSetup();
    }
    /**
     * clean all resources
     * @return {?}
     */
    ngOnDestroy() {
        if (this.keyInputSubjectSubscription)
            this.keyInputSubjectSubscription.unsubscribe();
        if (this.dataSourceSubscription)
            this.dataSourceSubscription.unsubscribe();
        if (this.keyEventSubjectSubscription)
            this.keyEventSubjectSubscription.unsubscribe();
        if (this.termSnippetSubscription)
            this.termSnippetSubscription.unsubscribe();
        if (this.term)
            this.term.dispose();
    }
    /**
     * @param {?} chars
     * @return {?}
     */
    write(chars) {
        this.term.write(chars);
    }
    /**
     * @param {?} opt
     * @return {?}
     */
    setDisplayOption(opt) {
        if (opt) {
            if (opt.fixedGrid != null) {
                console.debug("resizable will be ignored.");
                this.setTerminalBlock(false);
                this.removeTerminalDimensions();
            }
            else {
                this.setTerminalBlock(true);
            }
            this.displayOption = opt;
        }
        else
            console.warn(`A falsy option is not allowed`);
    }
    /**
     * @return {?}
     */
    get keyInput() {
        return this.keyInputSubject;
    }
    /**
     * @return {?}
     */
    get keyEventInput() {
        return this.keyEventSubject;
    }
    /**
     * @return {?}
     */
    get underlying() {
        return this.term;
    }
    /**
     * @return {?}
     */
    get isDraggableOnEdgeActivated() {
        return this.displayOption.activateDraggableOnEdge != undefined && this.displayOption.fixedGrid == undefined;
    }
    /**
     * After user coordinate dimensions of terminal, it's called.
     * @param {?} left
     * @param {?} top
     * @param {?} width
     * @param {?} height
     * @return {?}
     */
    onResizeEnd(left, top, width, height) {
        this.setTerminalDimensions(left, top, width, height);
    }
    /**
     * Before onResizeEnd is called, it valiates dimensions to change.
     * @return {?}
     */
    validatorFactory() {
        /** @type {?} */
        const comp = this;
        return (/**
         * @param {?} re
         * @return {?}
         */
        (re) => {
            /** @type {?} */
            const displayOption = comp.displayOption;
            if (displayOption.activateDraggableOnEdge) {
                /** @type {?} */
                let left = re.rectangle.left;
                /** @type {?} */
                let top = re.rectangle.top;
                /** @type {?} */
                let width = re.rectangle.width;
                /** @type {?} */
                let height = re.rectangle.height;
                if ((width < displayOption.activateDraggableOnEdge.minWidth) || (height < displayOption.activateDraggableOnEdge.minHeight)) {
                    return false;
                }
                else
                    return true;
            }
        });
    }
}
NgTerminalComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-terminal',
                template: "<global-style></global-style>\n\n<div #terminal class=\"terminal-outer\" mwlResizable [ngStyle]=\"terminalStyle\" [validateResize]=\"validatorFactory()\" [enableGhostResize]=\"true\" [resizeEdges]=\"isDraggableOnEdgeActivated ? {bottom: true, right: true} : {bottom: false, right: false}\"\n(resizeEnd)=\"onResizeEnd($event.rectangle.left, $event.rectangle.top, $event.rectangle.width, $event.rectangle.height)\">\n</div>",
                styles: [".terminal-outer{box-sizing:border-box;height:100%}"]
            }] }
];
/** @nocollapse */
NgTerminalComponent.ctorParameters = () => [];
NgTerminalComponent.propDecorators = {
    _dataSource: [{ type: Input, args: ['dataSource',] }],
    _displayOption: [{ type: Input, args: ['displayOption',] }],
    _style: [{ type: Input, args: ['style',] }],
    keyInputEmitter: [{ type: Output, args: ['keyInput',] }],
    keyEventEmitter: [{ type: Output, args: ['keyEvent',] }],
    terminalDiv: [{ type: ViewChild, args: ['terminal', { static: true },] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.term;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.fitAddon;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyInputSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyEventSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.termSnippetSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.afterViewInitSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyInputSubjectSubscription;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyEventSubjectSubscription;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.termSnippetSubscription;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.h;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.displayOption;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.dataSource;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.dataSourceSubscription;
    /** @type {?} */
    NgTerminalComponent.prototype.terminalStyle;
    /** @type {?} */
    NgTerminalComponent.prototype.keyInputEmitter;
    /** @type {?} */
    NgTerminalComponent.prototype.keyEventEmitter;
    /** @type {?} */
    NgTerminalComponent.prototype.terminalDiv;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctdGVybWluYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctdGVybWluYWwvIiwic291cmNlcyI6WyJsaWIvbmctdGVybWluYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBNEIsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFDbEosT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUNqQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFM0MsT0FBTyxFQUFFLE9BQU8sRUFBNEIsYUFBYSxFQUEyQixNQUFNLE1BQU0sQ0FBQztBQVNqRyxNQUFNLE9BQU8sbUJBQW1CO0lBa0Q5QjtRQS9DUSxvQkFBZSxHQUFvQixJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3pELG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQTJDLENBQUM7UUFDekUsdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQVksQ0FBQztRQUM3Qyx5QkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBSzNDLE1BQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0Usa0JBQWEsR0FBa0IsRUFBRSxDQUFDO1FBRzFDLGtCQUFhLEdBQVcsRUFBRSxDQUFDO1FBMkIzQixvQkFBZSxHQUFJLElBQUksWUFBWSxFQUFVLENBQUM7UUFHOUMsb0JBQWUsR0FBSSxJQUFJLFlBQVksRUFBMkMsQ0FBQztRQU03RSxJQUFJLENBQUMsdUJBQXVCLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxD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QUksRUFBRTs7Ozs7OztJQTlDdkMsbUNBQXVCOzs7OztJQUN2Qix1Q0FBMkI7Ozs7O0lBQzNCLDhDQUFpRTs7Ozs7SUFDakUsOENBQWlGOzs7OztJQUNqRixpREFBcUQ7Ozs7O0lBQ3JELG1EQUFtRDs7Ozs7SUFFbkQsMERBQWtEOzs7OztJQUNsRCwwREFBa0Q7Ozs7O0lBQ2xELHNEQUE4Qzs7Ozs7SUFDOUMsZ0NBQXFGOzs7OztJQUNyRiw0Q0FBMEM7Ozs7O0lBQzFDLHlDQUF1Qzs7Ozs7SUFDdkMscURBQTZDOztJQUM3Qyw0Q0FBMkI7O0lBMEIzQiw4Q0FDOEM7O0lBRTlDLDhDQUMrRTs7SUFFL0UsMENBQ3dCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIEFmdGVyVmlld0NoZWNrZWQsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRlcm1pbmFsIH0gZnJvbSAneHRlcm0nO1xuaW1wb3J0IHsgRml0QWRkb24gfSBmcm9tICd4dGVybS1hZGRvbi1maXQnO1xuaW1wb3J0IHsgTmdUZXJtaW5hbCB9IGZyb20gJy4vbmctdGVybWluYWwnO1xuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCBjb21iaW5lTGF0ZXN0LCBPYmplY3RVbnN1YnNjcmliZWRFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRGlzcGxheU9wdGlvbiB9IGZyb20gJy4vZGlzcGxheS1vcHRpb24nO1xuaW1wb3J0IHsgUmVzaXplRXZlbnQgfSBmcm9tICdhbmd1bGFyLXJlc2l6YWJsZS1lbGVtZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmctdGVybWluYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vbmctdGVybWluYWwuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9uZy10ZXJtaW5hbC5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTmdUZXJtaW5hbENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCwgTmdUZXJtaW5hbCwgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSB0ZXJtOiBUZXJtaW5hbDtcbiAgcHJpdmF0ZSBmaXRBZGRvbjogRml0QWRkb247XG4gIHByaXZhdGUga2V5SW5wdXRTdWJqZWN0OiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG4gIHByaXZhdGUga2V5RXZlbnRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8e2tleTogc3RyaW5nOyBkb21FdmVudDogS2V5Ym9hcmRFdmVudDt9PigpO1xuICBwcml2YXRlIHRlcm1TbmlwcGV0U3ViamVjdCA9IG5ldyBTdWJqZWN0PCgpPT52b2lkPigpO1xuICBwcml2YXRlIGFmdGVyVmlld0luaXRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgXG4gIHByaXZhdGUga2V5SW5wdXRTdWJqZWN0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUga2V5RXZlbnRTdWJqZWN0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgdGVybVNuaXBwZXRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBoID0gTWF0aC5tYXgoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCwgd2luZG93LmlubmVySGVpZ2h0IHx8IDApO1xuICBwcml2YXRlIGRpc3BsYXlPcHRpb246IERpc3BsYXlPcHRpb24gPSB7fTtcbiAgcHJpdmF0ZSBkYXRhU291cmNlOiBPYnNlcnZhYmxlPHN0cmluZz47XG4gIHByaXZhdGUgZGF0YVNvdXJjZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICB0ZXJtaW5hbFN0eWxlOiBvYmplY3QgPSB7fTtcblxuICBASW5wdXQoJ2RhdGFTb3VyY2UnKVxuICBzZXQgX2RhdGFTb3VyY2UoZHMpIHtcbiAgICBpZih0aGlzLmRhdGFTb3VyY2VTdWJzY3JpcHRpb24gIT0gbnVsbCl7XG4gICAgICB0aGlzLmRhdGFTb3VyY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gICAgdGhpcy5kYXRhU291cmNlID0gZHM7XG4gICAgdGhpcy5kYXRhU291cmNlU3Vic2NyaXB0aW9uID0gdGhpcy5kYXRhU291cmNlLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xuICAgICAgdGhpcy53cml0ZShkYXRhKTtcbiAgICB9KVxuICB9XG4gIGdldCBfZGF0YVNvdXJjZSgpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhU291cmNlO1xuICB9XG5cbiAgQElucHV0KCdkaXNwbGF5T3B0aW9uJylcbiAgc2V0IF9kaXNwbGF5T3B0aW9uKG9wdDogRGlzcGxheU9wdGlvbil7XG4gICAgdGhpcy5zZXREaXNwbGF5T3B0aW9uKG9wdCk7XG4gIH1cblxuICBASW5wdXQoJ3N0eWxlJylcbiAgc2V0IF9zdHlsZShvcHQ6IGFueSl7XG4gICAgdGhpcy5zZXRTdHlsZShvcHQpO1xuICB9XG5cbiAgQE91dHB1dCgna2V5SW5wdXQnKVxuICBrZXlJbnB1dEVtaXR0ZXIgID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgQE91dHB1dCgna2V5RXZlbnQnKVxuICBrZXlFdmVudEVtaXR0ZXIgID0gbmV3IEV2ZW50RW1pdHRlcjx7a2V5OiBzdHJpbmc7IGRvbUV2ZW50OiBLZXlib2FyZEV2ZW50O30+KCk7XG5cbiAgQFZpZXdDaGlsZCgndGVybWluYWwnLCB7IHN0YXRpYzogdHJ1ZSB9KSBcbiAgdGVybWluYWxEaXY6IEVsZW1lbnRSZWY7XG5cbiAgY29uc3RydWN0b3IoKSB7IFxuICAgIHRoaXMudGVybVNuaXBwZXRTdWJzY3JpcHRpb24gPSBjb21iaW5lTGF0ZXN0KHRoaXMudGVybVNuaXBwZXRTdWJqZWN0LCB0aGlzLmFmdGVyVmlld0luaXRTdWJqZWN0KS5zdWJzY3JpYmUoKFtzbmlwcGV0XSkgPT4ge1xuICAgICAgc25pcHBldCgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBvYnNlcnZhYmxlU2V0dXAoKXtcbiAgICB0aGlzLnRlcm0ub25EYXRhKChpbnB1dCkgPT4ge1xuICAgICAgdGhpcy5rZXlJbnB1dFN1YmplY3QubmV4dChpbnB1dCk7XG4gICAgfSk7XG4gICAgdGhpcy50ZXJtLm9uS2V5KGUgPT4ge1xuICAgICAgdGhpcy5rZXlFdmVudFN1YmplY3QubmV4dChlKTtcbiAgICB9KVxuICAgIHRoaXMua2V5SW5wdXRTdWJqZWN0U3Vic2NyaXB0aW9uID0gdGhpcy5rZXlJbnB1dFN1YmplY3Quc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICB0aGlzLmtleUlucHV0RW1pdHRlci5lbWl0KGRhdGEpO1xuICAgIH0pXG4gICAgdGhpcy5rZXlFdmVudFN1YmplY3RTdWJzY3JpcHRpb24gPSB0aGlzLmtleUV2ZW50U3ViamVjdC5zdWJzY3JpYmUoKGUpID0+IHtcbiAgICAgIHRoaXMua2V5RXZlbnRFbWl0dGVyLmVtaXQoZSk7XG4gICAgfSk7XG4gICAgdGhpcy5hZnRlclZpZXdJbml0U3ViamVjdC5uZXh0KCk7XG4gIH1cblxuICAvKipcbiAgICogc2V0IGJsb2NrIG9yIGlubGluZS1ibG9jayB0byAjdGVybWluYWwgZm9yIGZpdHRpbmcgY2xpZW50IG9yIG91dGVyIGVsZW1lbnRcbiAgICovXG4gIHByaXZhdGUgc2V0VGVybWluYWxCbG9jayhpc0Jsb2NrOiBib29sZWFuKXtcbiAgICBpZihpc0Jsb2NrKVxuICAgICAgdGhpcy50ZXJtaW5hbFN0eWxlWydkaXNwbGF5J10gPSAnYmxvY2snO1xuICAgIGVsc2VcbiAgICAgIHRoaXMudGVybWluYWxTdHlsZVsnZGlzcGxheSddID0gJ2lubGluZS1ibG9jayc7XG4gIH1cblxuICAvKipcbiAgICogc2V0IGRpbWVuc2lvbnNcbiAgICovXG4gIHByaXZhdGUgc2V0VGVybWluYWxEaW1lbnNpb25zKGxlZnQ6IG51bWJlciwgdG9wOiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWydsZWZ0J10gPSBsZWZ0ID8gYCR7bGVmdH1weGAgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWyd0b3AnXSA9IHRvcCA/IGAke3RvcH1weGAgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWyd3aWR0aCddID0gd2lkdGggPyBgJHt3aWR0aH1weGAgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWydoZWlnaHQnXSA9IGhlaWdodCA/IGAke2hlaWdodH1weGAgOiB1bmRlZmluZWQ7XG4gIH1cbiAgXG4gIC8qKlxuICAgKiByZW1vdmUgZGltZW5zaW9uc1xuICAgKi9cbiAgcHJpdmF0ZSByZW1vdmVUZXJtaW5hbERpbWVuc2lvbnMoKXtcbiAgICB0aGlzLnRlcm1pbmFsU3R5bGVbJ2xlZnQnXSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnRlcm1pbmFsU3R5bGVbJ3RvcCddID0gdW5kZWZpbmVkO1xuICAgIHRoaXMudGVybWluYWxTdHlsZVsnd2lkdGgnXSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnRlcm1pbmFsU3R5bGVbJ2hlaWdodCddID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgc2V0U3R5bGUoc3R5bGVPYmplY3Q6IGFueSl7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnRlcm1pbmFsU3R5bGUsIHN0eWxlT2JqZWN0KTtcbiAgfVxuXG4gIG5nT25Jbml0KCl7XG4gIH1cblxuICAvKipcbiAgICogV2hlbiBhIGRpbWVuc2lvbiBvZiBkaXYgY2hhbmdlcywgZml0IGEgdGVybWluYWwgaW4gZGl2LlxuICAgKi9cbiAgbmdBZnRlclZpZXdDaGVja2VkKCkge1xuICAgIGxldCBkaW1zID0gdGhpcy5maXRBZGRvbi5wcm9wb3NlRGltZW5zaW9ucygpO1xuICAgIGlmKGRpbXMgPT09IHVuZGVmaW5lZCB8fCBpc05hTihkaW1zLnJvd3MpIHx8IGRpbXMucm93cyA9PSBJbmZpbml0eSB8fCBpc05hTihkaW1zLmNvbHMpIHx8IGRpbXMuY29scyA9PSBJbmZpbml0eSl7XG4gICAgICB0aGlzLnRlcm0ucmVzaXplKDEwLCAxMCk7XG4gICAgfWVsc2UgaWYoIXRoaXMuZGlzcGxheU9wdGlvbi5maXhlZEdyaWQpe1xuICAgICAgdGhpcy5maXRBZGRvbi5maXQoKTtcbiAgICB9ZWxzZXtcbiAgICAgIHRoaXMudGVybS5yZXNpemUodGhpcy5kaXNwbGF5T3B0aW9uLmZpeGVkR3JpZC5jb2xzLCB0aGlzLmRpc3BsYXlPcHRpb24uZml4ZWRHcmlkLnJvd3MpO1xuICAgICAgbGV0IHh0ZXJtU2NyZWVuID0gdGhpcy50ZXJtLmVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgneHRlcm0tc2NyZWVuJylbMF07XG4gICAgICBsZXQgc2Nyb2xsQXJlYSA9IHRoaXMudGVybS5lbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3h0ZXJtLXNjcm9sbC1hcmVhJylbMF07XG4gICAgICBsZXQgdGVybWluYWwgPSB0aGlzLnRlcm0uZWxlbWVudDtcbiAgICAgIGNvbnN0IGNvbnRlbnRXaWR0aCA9IHh0ZXJtU2NyZWVuLmNsaWVudFdpZHRoO1xuICAgICAgY29uc3Qgc2Nyb2xsV2lkdGggPSB0ZXJtaW5hbC5jbGllbnRXaWR0aCAtIHNjcm9sbEFyZWEuY2xpZW50V2lkdGg7XG4gICAgICB0aGlzLnNldFRlcm1pbmFsRGltZW5zaW9ucyh1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGVudFdpZHRoICsgc2Nyb2xsV2lkdGgsIHVuZGVmaW5lZCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEl0IGNyZWF0ZXMgbmV3IHRlcm1pbmFsIGluICN0ZXJtaW5hbC5cbiAgICovXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmZpdEFkZG9uID0gbmV3IEZpdEFkZG9uKCk7XG4gICAgdGhpcy50ZXJtID0gbmV3IFRlcm1pbmFsKCk7XG4gICAgdGhpcy50ZXJtLm9wZW4odGhpcy50ZXJtaW5hbERpdi5uYXRpdmVFbGVtZW50KTtcbiAgICB0aGlzLnRlcm0ubG9hZEFkZG9uKHRoaXMuZml0QWRkb24pO1xuICAgIHRoaXMub2JzZXJ2YWJsZVNldHVwKCk7XG4gIH1cblxuICAvKipcbiAgICogY2xlYW4gYWxsIHJlc291cmNlc1xuICAgKi9cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYodGhpcy5rZXlJbnB1dFN1YmplY3RTdWJzY3JpcHRpb24pXG4gICAgICB0aGlzLmtleUlucHV0U3ViamVjdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIGlmKHRoaXMuZGF0YVNvdXJjZVN1YnNjcmlwdGlvbilcbiAgICAgIHRoaXMuZGF0YVNvdXJjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIGlmKHRoaXMua2V5RXZlbnRTdWJqZWN0U3Vic2NyaXB0aW9uKVxuICAgICAgdGhpcy5rZXlFdmVudFN1YmplY3RTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICBpZih0aGlzLnRlcm1TbmlwcGV0U3Vic2NyaXB0aW9uKVxuICAgIHRoaXMudGVybVNuaXBwZXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICBpZih0aGlzLnRlcm0pXG4gICAgICB0aGlzLnRlcm0uZGlzcG9zZSgpO1xuICB9XG5cbiAgd3JpdGUoY2hhcnM6IHN0cmluZykge1xuICAgIHRoaXMudGVybS53cml0ZShjaGFycyk7XG4gIH1cblxuICBzZXREaXNwbGF5T3B0aW9uKG9wdDogRGlzcGxheU9wdGlvbikge1xuICAgIGlmIChvcHQpIHtcbiAgICAgIGlmIChvcHQuZml4ZWRHcmlkICE9IG51bGwpIHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhcInJlc2l6YWJsZSB3aWxsIGJlIGlnbm9yZWQuXCIpO1xuICAgICAgICB0aGlzLnNldFRlcm1pbmFsQmxvY2soZmFsc2UpO1xuICAgICAgICB0aGlzLnJlbW92ZVRlcm1pbmFsRGltZW5zaW9ucygpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zZXRUZXJtaW5hbEJsb2NrKHRydWUpO1xuICAgICAgfVxuICAgICAgdGhpcy5kaXNwbGF5T3B0aW9uID0gb3B0O1xuICAgIH0gZWxzZVxuICAgICAgY29uc29sZS53YXJuKGBBIGZhbHN5IG9wdGlvbiBpcyBub3QgYWxsb3dlZGApO1xuICB9XG5cbiAgZ2V0IGtleUlucHV0KCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMua2V5SW5wdXRTdWJqZWN0O1xuICB9XG5cbiAgZ2V0IGtleUV2ZW50SW5wdXQoKTogT2JzZXJ2YWJsZTx7a2V5OiBzdHJpbmc7IGRvbUV2ZW50OiBLZXlib2FyZEV2ZW50O30+IHtcbiAgICByZXR1cm4gdGhpcy5rZXlFdmVudFN1YmplY3Q7XG4gIH1cblxuICBnZXQgdW5kZXJseWluZygpOiBUZXJtaW5hbCB7XG4gICAgcmV0dXJuIHRoaXMudGVybTtcbiAgfVxuXG4gIGdldCBpc0RyYWdnYWJsZU9uRWRnZUFjdGl2YXRlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5kaXNwbGF5T3B0aW9uLmFjdGl2YXRlRHJhZ2dhYmxlT25FZGdlICE9IHVuZGVmaW5lZCAmJiB0aGlzLmRpc3BsYXlPcHRpb24uZml4ZWRHcmlkID09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZnRlciB1c2VyIGNvb3JkaW5hdGUgZGltZW5zaW9ucyBvZiB0ZXJtaW5hbCwgaXQncyBjYWxsZWQuXG4gICAqIEBwYXJhbSBsZWZ0IFxuICAgKiBAcGFyYW0gdG9wIFxuICAgKiBAcGFyYW0gd2lkdGggXG4gICAqIEBwYXJhbSBoZWlnaHQgXG4gICAqL1xuICBvblJlc2l6ZUVuZChsZWZ0OiBudW1iZXIsIHRvcDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuc2V0VGVybWluYWxEaW1lbnNpb25zKGxlZnQsIHRvcCwgd2lkdGgsIGhlaWdodCk7XG4gIH1cblxuICAvKipcbiAgICogQmVmb3JlIG9uUmVzaXplRW5kIGlzIGNhbGxlZCwgaXQgdmFsaWF0ZXMgZGltZW5zaW9ucyB0byBjaGFuZ2UuXG4gICAqIEBwYXJhbSByZSBkaW1lbnNpb24gdG8gYmUgc3VibWl0dGVkIGZyb20gcmVzaXphYmxlIHN0dWZmXG4gICAqL1xuICB2YWxpZGF0b3JGYWN0b3J5KCk6IChyZTogUmVzaXplRXZlbnQpID0+IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvbXAgPSB0aGlzO1xuICAgIHJldHVybiAocmU6IFJlc2l6ZUV2ZW50KSA9PnsgXG4gICAgICBjb25zdCBkaXNwbGF5T3B0aW9uID0gY29tcC5kaXNwbGF5T3B0aW9uO1xuICAgICAgaWYoZGlzcGxheU9wdGlvbi5hY3RpdmF0ZURyYWdnYWJsZU9uRWRnZSl7XG4gICAgICAgIGxldCBsZWZ0ID0gcmUucmVjdGFuZ2xlLmxlZnQsIHRvcCA9IHJlLnJlY3RhbmdsZS50b3AsIHdpZHRoID0gcmUucmVjdGFuZ2xlLndpZHRoLCBoZWlnaHQgPSByZS5yZWN0YW5nbGUuaGVpZ2h0O1xuICAgICAgICBpZiAoKHdpZHRoIDwgZGlzcGxheU9wdGlvbi5hY3RpdmF0ZURyYWdnYWJsZU9uRWRnZS5taW5XaWR0aCkgfHwgKGhlaWdodCA8IGRpc3BsYXlPcHRpb24uYWN0aXZhdGVEcmFnZ2FibGVPbkVkZ2UubWluSGVpZ2h0KSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19